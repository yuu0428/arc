# Visual Audit Agent Prompt

## パラメータ
- 差分判定しきい値(重大): 1.0   # 単位: %
- ベースライン自動更新しきい値: 0.5  # 単位: %

## 目的
- `npm run dev` でローカルを起動し、`npm run visual:check` を実行。
- `reports/report.md` を読み、視覚差分を評価・要約・優先度付け。
- 軽微な差分（しきい値未満）はベースラインを更新（※更新手順を自動/半自動で実施）。
- 重大差分は原因仮説と修正案を提示し、必要ならソースを修正して再検証。
- すべての操作は再現可能な手順・出力で残す。

## 前提
- 実行環境: WSL 上の同一プロジェクトルート。
- スクリプト: `scripts/visual-check.mjs`
- 出力物: `reports/baseline/*`, `reports/current/*`, `reports/diff/*`, `reports/report.md`

## 実行手順（必ず順守）
1. **開発サーバ起動**  
   - 別ターミナル/ペインで `npm run dev` を起動（既に起動中ならスキップ）。
2. **ビジュアルチェック実行**  
   - `npm run visual:check` を実行。
   - 失敗時はログを読み、依存不足・待機条件不足（`networkidle`/フォント読み込み等）を特定して `scripts/visual-check.mjs` を最小修正→再実行。
3. **レポート読取**  
   - `reports/report.md` を開き、各ページの差分率を抽出。
4. **判定・アクション**  
   - 差分率 < ベースライン自動更新しきい値: **ベースライン更新対象**  
   - ベースライン自動更新しきい値 ≤ 差分率 < 重大しきい値: **要確認（軽微）**  
   - 重大しきい値 ≤ 差分率: **要対応（重大）**
5. **ベースライン更新（安全運用）**  
   - 対象ページについて `reports/current/<name>.png` を `reports/baseline/<name>.png` に上書き。  
   - 更新後に再度 `npm run visual:check` を回し、差分が 0% に近いことを確認。
6. **重大差分の調査・修正**  
   - 原因仮説（CSS揺れ/アニメ/フォント/日付・動的DOM等）を列挙。  
   - 修正案（例：フォント読み込み待ち、アニメ一時無効化、データ固定、スナップショット点の見直し等）を提示。  
   - 合意可能な最小修正を実施し、再度 2〜4 を実行。
7. **成果物の要約**  
   - 形式に従い出力（下記参照）。コミットが必要ならコミット文を生成。

## 出力形式（厳守）
```
# Visual Audit Summary (YYYY-MM-DD HH:mm)
- 実行結果: 成功/要再実行
- 重大しきい値: X.X% / 自動更新しきい値: Y.Y%

## 差分サマリ
- {pageName}: {diff}% → {判定: 更新/要確認/要対応}
  - 原因仮説: ...
  - 次アクション: ...

## 実施アクション
- ベースライン更新: [pageA, pageB]
- スクリプト修正: 有/無（修正点: …）
- 再実行結果: OK/NG

## 提案コミットメッセージ
<type>(visual): update baseline for {pages}; stabilize fonts/animations
```

## 注意事項
- 画像はCLI上では表示不可。**`reports/` のパスと diff 率をソース・オブ・トゥルース**とする。
- 動的要素は極力固定（日時・乱数・アニメ）。必要に応じ `visual-check.mjs` の待機や無効化CSSを適用。
- 変更は最小単位で行い、理由を必ずサマリに残す。

## 失敗時の自己修復
- `playwright` 実行失敗 → `npx playwright install` を提案/実行。
- タイムアウト → `waitForTimeout` 追加、`waitUntil` 見直し。
- 画像サイズ不一致 → ビューポート統一、既存のクロップ処理を維持。
